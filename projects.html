<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои проекты</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #logout {
            padding: 8px 16px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #logout:hover {
            background-color: #cc0000;
        }
        
        #projects-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .project-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .project-card h3 {
            margin-top: 0;
            color: #333;
        }
        
        .no-projects {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>Мои проекты</h1>
        <button id="logout">Выйти</button>
    </header>
    
    <div id="projects-container"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        
        // Инициализация Supabase
        const supabaseUrl = 'https://ijksnxqnabykqjvqeoud.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqa3NueHFuYWJ5a3FqdnFlb3VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNDI0MzMsImV4cCI6MjA2NDYxODQzM30.TXQO0z4iEP95eVVwirdEwww0BWJyPmKKg_DSC4SSr9Q'
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        // Проверка авторизации
        const session = JSON.parse(localStorage.getItem('auth')) || JSON.parse(sessionStorage.getItem('auth'))
        
        if (!session) {
            window.location.href = 'index.html'
        }
        
        // Загрузка проектов
        async function loadProjects() {
            const projectsContainer = document.getElementById('projects-container')
            projectsContainer.innerHTML = '<div class="no-projects">Загрузка...</div>'
            
            try {
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('user_id', session.user.id)
                    
                if (error) throw error
                
                if (projects.length === 0) {
                    projectsContainer.innerHTML = '<div class="no-projects">У вас пока нет проектов</div>'
                } else {
                    projectsContainer.innerHTML = ''
                    projects.forEach(project => {
                        const projectCard = document.createElement('div')
                        projectCard.className = 'project-card'
                        projectCard.innerHTML = `
                            <h3>${project.title || 'Без названия'}</h3>
                            <p>Тип: ${project.project_type || 'Не указан'}</p>
                            <p>Сроки: ${formatDate(project.start_date)} - ${formatDate(project.end_date)}</p>
                            <p>Бюджет: ${project.budget || '0'} руб.</p>
                        `
                        projectsContainer.appendChild(projectCard)
                    })
                }
            } catch (error) {
                console.error('Ошибка загрузки проектов:', error)
                projectsContainer.innerHTML = '<div class="no-projects">Ошибка загрузки проектов</div>'
            }
        }
        
        // Форматирование даты
        function formatDate(dateString) {
            if (!dateString) return 'Не указана'
            const date = new Date(dateString)
            return date.toLocaleDateString('ru-RU')
        }
        
        // Выход из системы
        document.getElementById('logout').addEventListener('click', async () => {
            try {
                await supabase.auth.signOut()
                localStorage.removeItem('auth')
                sessionStorage.removeItem('auth')
                window.location.href = 'index.html'
            } catch (error) {
                console.error('Ошибка выхода:', error)
            }
        })
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', loadProjects)
    </script>
</body>
</html>