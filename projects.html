<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
    <title>Управление проектами</title>
    <link rel="stylesheet" href="style.css">
</head>
<style>
    .main-content {
        display: none;
    }
</style>
<body class="projects-body">
    <!-- Боковая панель -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Управление проектами</h2>
        </div>
        
        <div class="nav-links">
            <a href="#" class="nav-link" id="dashboard-link">Панель управления</a>
            <a href="#" class="nav-link" id="projects-link">Мои проекты</a>
            <a href="#" class="nav-link" id="profile-link">Мой профиль</a>
            <a href="#" class="nav-link" id="settings-link">Настройки</a>
        </div>
        
        <button class="logout-btn" id="logout">Выйти</button>
    </div>
	<div class="mobile-menu-btn" id="mobileMenuBtn">☰</div>
    
    <!-- Основной контент - Панель управления -->
    <div class="main-content" id="dashboard-content">
        <div class="content-header">
            <h1>Панель управления</h1>
            <button class="new-project-btn" id="new-project-btn">Создать новый проект</button>
        </div>
        
        <div class="dashboard-stats" id="dashboard-stats">
            <div class="stat-card">
                <h3>Активные проекты</h3>
                <p>Общее количество активных проектов</p>
                <div class="stat-value" id="active-projects-count">0</div>
            </div>
            
            <div class="stat-card">
                <h3>Предстоящие дедлайны</h3>
                <p>Проекты с близкими сроками завершения</p>
                <div class="stat-value" id="upcoming-deadlines-count">0</div>
            </div>
            
            <div class="stat-card">
                <h3>Недавно созданные</h3>
                <p>Проекты, созданные за последние 7 дней</p>
                <div class="stat-value" id="recent-projects-count">0</div>
            </div>
        </div>
        
        <div class="recent-projects">
            <div class="projects-section">
                <div class="section-header">
                    <h2>Последние проекты</h2>
                </div>
                <p>Ваши недавно созданные или обновленные проекты</p>
                
                <div id="recent-projects-container">
                    <div class="no-projects">
                        <p>Загрузка проектов...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Форма создания проекта -->
    <div class="main-content create-project-container" id="create-project-content">
        <div class="create-project-header">
            <h1>Создание нового проекта</h1>
            <p>Заполните форму для создания нового проекта</p>
        </div>
        
        <!-- Основная информация -->
        <div class="form-section">
            <div class="form-section-header">
                <h2>Основная информация</h2>
                <p>Укажите основные параметры проекта</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="project-type">Тип проекта</label>
                    <select id="project-type">
                        <option value="">Выберите тип проекта</option>
                        <option value="research">Исследовательский</option>
                        <option value="development">Разработка</option>
                        <option value="education">Образовательный</option>
                        <option value="social">Социальный</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="project-name">Название проекта</label>
                    <input type="text" id="project-name" placeholder="Введите название проекта">
                </div>
            </div>
            
            <div class="form-group">
                <label for="project-description">Описание проекта</label>
                <textarea id="project-description" placeholder="Опишите ваш проект"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-geography">География проекта</label>
                <input type="text" id="project-geography" placeholder="Укажите географию проекта">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="start-date">Дата начала реализации</label>
                    <input type="date" id="start-date">
                </div>
                
                <div class="form-group">
                    <label for="end-date">Дата окончания реализации</label>
                    <input type="date" id="end-date">
                </div>
            </div>
        </div>
        
        <!-- Содержание проекта -->
        <div class="form-section">
            <div class="form-section-header">
                <h2>Содержание проекта</h2>
                <p>Детальная информация о целях и результатах проекта</p>
            </div>
            
            <div class="form-group">
                <label for="project-goal">Цель проекта</label>
                <textarea id="project-goal" placeholder="Сформулируйте основную цель проекта"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-results">Ожидаемые результаты проекта</label>
                <textarea id="project-results" placeholder="Опишите ожидаемые результаты"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-tasks">Задачи проекта</label>
                <textarea id="project-tasks" placeholder="Перечислите основные задачи проекта"></textarea>
            </div>
        </div>
        
        <!-- Дополнительная информация -->
        <div class="form-section">
            <div class="form-section-header">
                <h2>Дополнительная информация</h2>
                <p>Необязательные, но полезные данные о проекте</p>
            </div>
            
            <div class="form-group">
                <label for="project-partners">Партнеры проекта</label>
                <textarea id="project-partners" placeholder="Укажите партнеров проекта (если есть)"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-development">Дальнейшее развитие проекта</label>
                <textarea id="project-development" placeholder="Опишите перспективы развития проекта"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-resources">Источники ресурсного обеспечения проекта</label>
                <textarea id="project-resources" placeholder="Укажите источники финансирования и другие ресурсы"></textarea>
            </div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="form-actions">
            <button class="cancel-btn" id="cancel-project-btn">Отмена</button>
            <button class="submit-btn" id="submit-project-btn">Создать проект</button>
        </div>
    </div>
    
    <!-- Список проектов -->
    <div class="main-content" id="projects-list-content">
        <div class="content-header">
            <h1>Мои проекты</h1>
            <button class="new-project-btn" id="new-project-btn-list">Создать новый проект</button>
        </div>
        
        <div class="projects-section">
            <div id="projects-container">
                <div class="no-projects">
                    <p>Загрузка проектов...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Просмотр проекта -->
    <div class="main-content project-view" id="project-view-content">
        <div class="content-header">
            <h1 id="project-view-title">Название проекта</h1>
            <button class="back-btn" id="back-to-projects-btn">← Назад к проектам</button>
        </div>
        
        <div class="projects-section">
            <div class="project-tabs">
                <button class="project-tab active" data-tab="overview">Обзор</button>
                <button class="project-tab" data-tab="budget">Бюджет</button>
            </div>
            
            <div class="project-tab-content active" id="overview-tab">
                <div class="project-info-section">
                    <h3>Основная информация</h3>
                    <p><strong>Тип проекта:</strong> <span id="project-type-view"></span></p>
                    <p><strong>Описание:</strong> <span id="project-description-view"></span></p>
                    <p><strong>География:</strong> <span id="project-geography-view"></span></p>
                    <p><strong>Дата начала:</strong> <span id="project-start-date-view"></span></p>
                    <p><strong>Дата окончания:</strong> <span id="project-end-date-view"></span></p>
                </div>
                
                <div class="project-info-section">
                    <h3>Содержание проекта</h3>
                    <p><strong>Цель проекта:</strong> <span id="project-goal-view"></span></p>
                    <p><strong>Ожидаемые результаты:</strong> <span id="project-results-view"></span></p>
                    <p><strong>Задачи проекта:</strong> <span id="project-tasks-view"></span></p>
                </div>
                
                <div class="project-info-section">
                    <h3>Дополнительная информация</h3>
                    <p><strong>Партнеры:</strong> <span id="project-partners-view"></span></p>
                    <p><strong>Дальнейшее развитие:</strong> <span id="project-development-view"></span></p>
                    <p><strong>Ресурсы:</strong> <span id="project-resources-view"></span></p>
                </div>
            </div>
            
            <div class="project-tab-content" id="budget-tab">
            <h2>Бюджет проекта</h2>
            
            <!-- 1. Оплата труда -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">1.1 Оплата труда штатных работников</h3>
                    </div>
                    <div class="budget-item-rows" id="salary-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="salary-amount">
                            <input type="text" placeholder="Комментарий" class="salary-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="salary">Добавить строку</button>
                </div>
                
                <!-- 1.2. Выплаты физическим лицам -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">1.2. Выплаты физическим лицам по гражданско-правовым договорам</h3>
                    </div>
                    <div class="budget-item-rows" id="contract-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="contract-amount">
                            <input type="text" placeholder="Комментарий" class="contract-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="contract">Добавить строку</button>
                </div>
                
                <!-- 1.3. Страховые взносы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">1.3. Страховые взносы</h3>
                    </div>
                    <div class="budget-item-rows" id="insurance-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="insurance-amount">
                            <input type="text" placeholder="Комментарий" class="insurance-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="insurance">Добавить строку</button>
                </div>
                
                <!-- 2. Командировочные расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">2. Командировочные расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="travel-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="travel-amount">
                            <input type="text" placeholder="Комментарий" class="travel-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="travel">Добавить строку</button>
                </div>
                
                <!-- 3. Офисные расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">3. Офисные расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="office-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="office-amount">
                            <input type="text" placeholder="Комментарий" class="office-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="office">Добавить строку</button>
                </div>
                
                <!-- 4. Приобретение оборудования -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">4. Приобретение, аренда специализированного оборудования</h3>
                    </div>
                    <div class="budget-item-rows" id="equipment-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="equipment-amount">
                            <input type="text" placeholder="Комментарий" class="equipment-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="equipment">Добавить строку</button>
                </div>
                
                <!-- 5. Разработка и поддержка сайтов -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">5. Разработка и поддержка сайтов, информационных систем</h3>
                    </div>
                    <div class="budget-item-rows" id="it-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="it-amount">
                            <input type="text" placeholder="Комментарий" class="it-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="it">Добавить строку</button>
                </div>
                
                <!-- 6. Консультационные услуги -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">6. Оплата юридических, информационных, консультационных услуг</h3>
                    </div>
                    <div class="budget-item-rows" id="consulting-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="consulting-amount">
                            <input type="text" placeholder="Комментарий" class="consulting-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="consulting">Добавить строку</button>
                </div>
                
                <!-- 7. Расходы на мероприятия -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">7. Расходы на проведение мероприятий</h3>
                    </div>
                    <div class="budget-item-rows" id="event-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="event-amount">
                            <input type="text" placeholder="Комментарий" class="event-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="event">Добавить строку</button>
                </div>
                
                <!-- 8. Издательские расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">8. Издательские, полиграфические расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="publishing-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="publishing-amount">
                            <input type="text" placeholder="Комментарий" class="publishing-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="publishing">Добавить строку</button>
                </div>
                
                <!-- 9. Прочие расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">9. Прочие прямые расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="other-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="other-amount">
                            <input type="text" placeholder="Комментарий" class="other-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="other">Добавить строку</button>
                </div>
                
                <div class="total-amount">
                    Общая сумма затрат: <span id="total-amount">0</span> руб.
                </div>
                
                <button class="submit-btn" id="save-budget-btn">Сохранить бюджет</button>
            </div>
        </div>
    </div>
<!-- Мой профиль -->
<div class="main-content" id="profile-content">
    <div class="content-header">
        <h1>Мой профиль</h1>
    </div>
    
    <div class="projects-section">
        <div class="profile-info">
            <div class="profile-row">
                <span class="profile-label">Email:</span>
                <span class="profile-value" id="profile-email"></span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Телефон:</span>
                <span class="profile-value" id="profile-phone"></span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Организация:</span>
                <span class="profile-value" id="profile-organization"></span>
            </div>
        </div>
    </div>
</div>

<!-- Настройки -->
<div class="main-content" id="settings-content">
    <div class="content-header">
        <h1>Настройки</h1>
    </div>
    
    <div class="projects-section">
        <div class="about-section">
            <h2>О приложении</h2>
            <p>Информация о системе бюджетирования проектов</p>
            <p>Система бюджетирования проектов предназначена для эффективного планирования, учета и контроля финансовых ресурсов в рамках реализации различных проектов. Она позволяет:</p>
            <ul>
                <li>Создавать и управлять проектами с детальным бюджетом</li>
                <li>Контролировать расходы по категориям</li>
                <li>Контролировать сроки завершения проектов</li>
            </ul>
            <p>Версия 1.0.0</p>
        </div>
    </div>
</div>
      <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        
// Инициализация Supabase
const supabaseUrl = 'https://ijksnxqnabykqjvqeoud.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqa3NueHFuYWJ5a3FqdnFlb3VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNDI0MzMsImV4cCI6MjA2NDYxODQzM30.TXQO0z4iEP95eVVwirdEwww0BWJyPmKKg_DSC4SSr9Q'
const supabase = createClient(supabaseUrl, supabaseKey)

// Текущий просматриваемый проект
let currentProject = null;
let budgetCategories = [];
let budgetItems = [];

// Проверка авторизации
async function checkAuth() {
    const session = JSON.parse(localStorage.getItem('auth')) || JSON.parse(sessionStorage.getItem('auth'))
    
    if (!session) {
        window.location.href = 'index.html'
        return null
    }
    
    try {
        const { data, error } = await supabase.auth.getUser(session.access_token)
        
        if (error) {
            localStorage.removeItem('auth')
            sessionStorage.removeItem('auth')
            window.location.href = 'index.html'
            return null
        }
        return data.user
    } catch (error) {
        console.error('Ошибка проверки авторизации:', error)
        window.location.href = 'index.html'
        return null
    }
}

// Форматирование даты
function formatDate(dateString) {
    if (!dateString) return 'Не указана'
    const date = new Date(dateString)
    return date.toLocaleDateString('ru-RU')
}

// Загрузка проектов пользователя
async function loadUserProjects(userId) {
    const projectsContainer = document.getElementById('projects-container')
    projectsContainer.innerHTML = '<div class="no-projects"><p>Загрузка проектов...</p></div>'
    
    try {
        const { data: projects, error } = await supabase
            .from('projects')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
        
        if (error) throw error
        
        if (projects.length === 0) {
            projectsContainer.innerHTML = `
                <div class="no-projects">
                    <p>У вас пока нет проектов</p>
                    <button class="create-first-btn" id="create-first-btn-list">Создать первый проект</button>
                </div>
            `
        } else {
            projectsContainer.innerHTML = `
                <div class="projects-list">
                    ${projects.map(project => `
                        <div class="project-card" data-project-id="${project.id}">
                            <div class="project-header">
                                <h3 class="project-title">${project.title || 'Без названия'}</h3>
                                <span class="project-type">${project.project_type || 'Не указан'}</span>
                            </div>
                            <div class="project-details">
                                <div class="detail-item">
                                    <div class="detail-label">Начало</div>
                                    <div class="detail-value">${formatDate(project.start_date)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Окончание</div>
                                    <div class="detail-value">${formatDate(project.end_date)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">География</div>
                                    <div class="detail-value">${project.geography || 'Не указана'}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `

            // Добавляем обработчики клика на карточки проектов
            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const projectId = card.getAttribute('data-project-id')
                    const project = projects.find(p => p.id == projectId)
                    if (project) {
                        showProjectDetails(project)
                    }
                })
            })
        }
    } catch (error) {
        console.error('Ошибка загрузки проектов:', error)
        projectsContainer.innerHTML = `
            <div class="no-projects">
                <p>Ошибка загрузки проектов</p>
            </div>
        `
    }
}

// Загрузка статистики для панели управления
async function loadDashboardStats(userId) {
    try {
        // Получаем все проекты пользователя
        const { data: projects, error } = await supabase
            .from('projects')
            .select('*')
            .eq('user_id', userId)
        
        if (error) throw error
        
        // Текущая дата
        const today = new Date();
        
        // 1. Активные проекты (где текущая дата между start_date и end_date)
        const activeProjects = projects.filter(project => {
            const startDate = new Date(project.start_date);
            const endDate = new Date(project.end_date);
            return today >= startDate && today <= endDate;
        });
        
        // 2. Проекты с близкими дедлайнами (до окончания осталось <= 7 дней)
        const upcomingDeadlines = projects.filter(project => {
            const endDate = new Date(project.end_date);
            const diffTime = endDate - today;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            return diffDays <= 7 && diffDays >= 0;
        });
        
        // 3. Недавно созданные проекты (созданы за последние 7 дней)
        const recentProjects = projects.filter(project => {
            const createdDate = new Date(project.created_at);
            const diffTime = today - createdDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            return diffDays <= 7;
        });
        
        // Обновляем статистику на странице
        document.getElementById('active-projects-count').textContent = activeProjects.length;
        document.getElementById('upcoming-deadlines-count').textContent = upcomingDeadlines.length;
        document.getElementById('recent-projects-count').textContent = recentProjects.length;
        
        // Отображаем последние проекты (например, 5 самых новых)
        const recentProjectsContainer = document.getElementById('recent-projects-container');
        const recentProjectsToShow = projects.slice(0, 5);
        
        if (recentProjectsToShow.length === 0) {
            recentProjectsContainer.innerHTML = `
                <div class="no-projects">
                    <p>У вас пока нет проектов</p>
                    <button class="create-first-btn" id="create-first-btn-dashboard">Создать первый проект</button>
                </div>
            `;
        } else {
            recentProjectsContainer.innerHTML = `
                <div class="projects-list">
                    ${recentProjectsToShow.map(project => `
                        <div class="project-card" data-project-id="${project.id}">
                            <div class="project-header">
                                <h3 class="project-title">${project.title || 'Без названия'}</h3>
                                <span class="project-type">${project.project_type || 'Не указан'}</span>
                            </div>
                            <div class="project-details">
                                <div class="detail-item">
                                    <div class="detail-label">Начало</div>
                                    <div class="detail-value">${formatDate(project.start_date)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Окончание</div>
                                    <div class="detail-value">${formatDate(project.end_date)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">География</div>
                                    <div class="detail-value">${project.geography || 'Не указана'}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Добавляем обработчики клика на карточки проектов
            document.querySelectorAll('#recent-projects-container .project-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const projectId = card.getAttribute('data-project-id')
                    const project = recentProjectsToShow.find(p => p.id == projectId)
                    if (project) {
                        showProjectDetails(project)
                    }
                })
            })
        }
        
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
        document.getElementById('dashboard-stats').innerHTML = `
            <div class="no-projects">
                <p>Ошибка загрузки статистики</p>
            </div>
        `;
    }
}

// Загрузка категорий бюджета
async function loadBudgetCategories() {
    try {
        const { data, error } = await supabase
            .from('budget_categories')
            .select('*')
            .order('id', { ascending: true });
        
        if (error) throw error;
        
        budgetCategories = data;
        return data;
    } catch (error) {
        console.error('Ошибка загрузки категорий бюджета:', error);
        return [];
    }
}

// Загрузка данных бюджета для проекта
async function loadProjectBudget(projectId) {
    try {
        // Сначала загружаем категории, если еще не загружены
        if (budgetCategories.length === 0) {
            await loadBudgetCategories();
        }

        const { data, error } = await supabase
            .from('budget_items')
            .select(`
                *,
                budget_categories:category_id (name, description)
            `)
            .eq('project_id', projectId)
            .order('category_id', { ascending: true })
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        budgetItems = data || [];
        renderBudgetItems();
        calculateTotal();
    } catch (error) {
        console.error('Ошибка загрузки бюджета:', error);
        // Создаем пустые строки для каждой категории
        budgetItems = [];
        renderBudgetItems();
        calculateTotal();
    }
}

// Отображение данных бюджета
function renderBudgetItems() {
    // Очищаем все контейнеры
    document.querySelectorAll('.budget-item-rows').forEach(container => {
        container.innerHTML = '';
    });
    
    // Группируем элементы по категориям
    const itemsByCategory = {};
    budgetItems.forEach(item => {
        if (!itemsByCategory[item.category_id]) {
            itemsByCategory[item.category_id] = [];
        }
        itemsByCategory[item.category_id].push(item);
    });
    
    // Для каждой категории создаем строки
    budgetCategories.forEach(category => {
        const categoryItems = itemsByCategory[category.id] || [];
        const container = document.getElementById(`${getCategorySlug(category.name)}-rows`);
        
        if (categoryItems.length === 0) {
            // Добавляем одну пустую строку, если нет элементов
            container.appendChild(createBudgetRow(category.id));
        } else {
            // Добавляем все существующие элементы
            categoryItems.forEach(item => {
                container.appendChild(createBudgetRow(category.id, item.amount, item.comment, item.id));
            });
        }
    });
    
    // Добавляем обработчики событий для новых полей ввода
    setupBudgetInputListeners();
}

// Создание строки бюджета
function createBudgetRow(categoryId, amount = '', comment = '', itemId = null) {
    const category = budgetCategories.find(c => c.id === categoryId);
    if (!category) return document.createElement('div');
    
    const slug = getCategorySlug(category.name);
    const row = document.createElement('div');
    row.className = 'budget-row';
    row.dataset.categoryId = categoryId;
    if (itemId) row.dataset.itemId = itemId;
    
    row.innerHTML = `
        <input type="number" placeholder="Сумма" class="${slug}-amount" value="${amount}">
        <input type="text" placeholder="Комментарий" class="${slug}-comment" value="${comment || ''}">
        <button class="remove-row-btn" data-type="${slug}">×</button>
    `;
    
    return row;
}

// Получение slug для категории (для использования в классах)
function getCategorySlug(categoryName) {
    if (!categoryName) return '';
    
    // Создаем маппинг для предсказуемых slug
    const slugMap = {
        '1.1 Оплата труда штатных работников': 'salary',
        '1.2 Выплаты физическим лицам': 'contract',
        '1.3 Страховые взносы': 'insurance',
        '2 Командировочные расходы': 'travel',
        '3 Офисные расходы': 'office',
        '4 Приобретение оборудования': 'equipment',
        '5 Разработка и поддержка сайтов': 'it',
        '6 Консультационные услуги': 'consulting',
        '7 Расходы на мероприятия': 'event',
        '8 Издательские расходы': 'publishing',
        '9 Прочие прямые расходы': 'other'
    };
    
    return slugMap[categoryName] || categoryName
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '')
        .replace(/^(\d+\.\d+)/, '$1-')
        .replace(/\./g, '');
}

// Расчет общей суммы
function calculateTotal() {
    let total = 0;
    
    // Суммируем значения всех полей ввода с суммами
    document.querySelectorAll('[class$="-amount"]').forEach(input => {
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            total += value;
        }
    });
    
    document.getElementById('total-amount').textContent = total.toFixed(2);
}

// Установка обработчиков событий для полей ввода
function setupBudgetInputListeners() {
    document.querySelectorAll('[class$="-amount"]').forEach(input => {
        input.addEventListener('input', calculateTotal);
    });
    
    // Обработчики для кнопок удаления строк
    document.querySelectorAll('.remove-row-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('.budget-row');
            const itemId = row.dataset.itemId;
            
            if (itemId) {
                if (confirm('Удалить эту строку бюджета?')) {
                    deleteBudgetItem(itemId).then(() => {
                        row.remove();
                        calculateTotal();
                    });
                }
            } else {
                row.remove();
                calculateTotal();
            }
        });
    });
}

// Удаление элемента бюджета
async function deleteBudgetItem(itemId) {
    try {
        const { error } = await supabase
            .from('budget_items')
            .delete()
            .eq('id', itemId);
            
        if (error) throw error;
        
        // Обновляем локальный список элементов
        budgetItems = budgetItems.filter(item => item.id != itemId);
    } catch (error) {
        console.error('Ошибка удаления элемента бюджета:', error);
        alert('Ошибка при удалении элемента бюджета');
    }
}

// Показ деталей проекта
async function showProjectDetails(project) {
    currentProject = project;
    
    // Заполняем информацию о проекте
    document.getElementById('project-view-title').textContent = project.title || 'Без названия';
    document.getElementById('project-type-view').textContent = project.project_type || 'Не указан';
    document.getElementById('project-description-view').textContent = project.description || 'Не указано';
    document.getElementById('project-geography-view').textContent = project.geography || 'Не указана';
    document.getElementById('project-start-date-view').textContent = formatDate(project.start_date);
    document.getElementById('project-end-date-view').textContent = formatDate(project.end_date);
    document.getElementById('project-goal-view').textContent = project.goal || 'Не указана';
    document.getElementById('project-results-view').textContent = project.expected_results || 'Не указаны';
    document.getElementById('project-tasks-view').textContent = project.tasks || 'Не указаны';
    document.getElementById('project-partners-view').textContent = project.partners || 'Не указаны';
    document.getElementById('project-development-view').textContent = project.future_development || 'Не указано';
    document.getElementById('project-resources-view').textContent = project.resources || 'Не указаны';
    
    // Загружаем категории бюджета (если еще не загружены)
    if (budgetCategories.length === 0) {
        await loadBudgetCategories();
    }
    
    // Загружаем данные бюджета
    await loadProjectBudget(project.id);
    
    // Показываем вкладку просмотра проекта
    showSection('project-view-content');
}

// Переключение между разделами
function showSection(sectionId) {
    const sections = [
        'dashboard-content', 
        'create-project-content', 
        'projects-list-content', 
        'project-view-content',
        'profile-content',
        'settings-content'
    ];
    sections.forEach(id => {
        document.getElementById(id).style.display = id === sectionId ? 'block' : 'none'
    })
    
    // Обновляем активную ссылку в навигации
    const navLinks = ['dashboard-link', 'projects-link', 'profile-link', 'settings-link']
    navLinks.forEach(id => {
        const link = document.getElementById(id)
        if (link) {
            link.classList.toggle('active', id === `${sectionId.replace('-content', '-link')}`)
        }
    })
    
    // Если показываем список проектов - загружаем их
    if (sectionId === 'projects-list-content') {
        checkAuth().then(user => {
            if (user) loadUserProjects(user.id)
        })
    }
    
    // Если показываем панель управления - загружаем статистику
    if (sectionId === 'dashboard-content') {
        checkAuth().then(user => {
            if (user) loadDashboardStats(user.id)
        })
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', async () => {
    const user = await checkAuth()
    if (!user) return
    
    // Настройка обработчиков навигации
    document.getElementById('dashboard-link').addEventListener('click', (e) => {
        e.preventDefault()
        showSection('dashboard-content')
    })
    
    document.getElementById('projects-link').addEventListener('click', (e) => {
        e.preventDefault()
        showSection('projects-list-content')
    })
	document.getElementById('mobileMenuBtn').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.toggle('active');
});
    // Обработчик кнопки профиля
document.getElementById('profile-link').addEventListener('click', async (e) => {
    e.preventDefault();
    showSection('profile-content');
    
    // Загружаем данные профиля
    const user = await checkAuth();
    if (!user) return;
    
    // Получаем данные профиля из таблицы profiles
    try {
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (error) throw error;
        
        // Заполняем данные профиля
        document.getElementById('profile-email').textContent = user.email;
        document.getElementById('profile-phone').textContent = profile?.phone || 'Не указан';
        document.getElementById('profile-organization').textContent = profile?.organization || 'Не указана';
        
    } catch (error) {
        console.error('Ошибка загрузки профиля:', error);
        document.getElementById('profile-email').textContent = user.email;
        document.getElementById('profile-phone').textContent = 'Ошибка загрузки';
        document.getElementById('profile-organization').textContent = 'Ошибка загрузки';
    }
});

// Обработчик кнопки настроек
document.getElementById('settings-link').addEventListener('click', (e) => {
    e.preventDefault();
    showSection('settings-content');
});
    // Обработчики кнопок создания проекта
    document.getElementById('new-project-btn').addEventListener('click', () => {
        showSection('create-project-content')
    })
    
    document.getElementById('new-project-btn-list').addEventListener('click', () => {
        showSection('create-project-content')
    })
    
    document.addEventListener('click', (e) => {
        if (e.target.id === 'create-first-btn' || 
            e.target.id === 'create-first-btn-list' || 
            e.target.id === 'create-first-btn-dashboard') {
            showSection('create-project-content')
        }
    })
    
    // Обработчик кнопки отмены
    document.getElementById('cancel-project-btn').addEventListener('click', () => {
        showSection('projects-list-content')
    })
    
    // Обработчик кнопки создания проекта
    document.getElementById('submit-project-btn').addEventListener('click', async () => {
        const user = await checkAuth()
        if (!user) return
        
        // Собираем данные из формы
        const projectData = {
            user_id: user.id,
            project_type: document.getElementById('project-type').value,
            title: document.getElementById('project-name').value,
            description: document.getElementById('project-description').value,
            geography: document.getElementById('project-geography').value,
            start_date: document.getElementById('start-date').value,
            end_date: document.getElementById('end-date').value,
            goal: document.getElementById('project-goal').value,
            expected_results: document.getElementById('project-results').value,
            tasks: document.getElementById('project-tasks').value,
            partners: document.getElementById('project-partners').value,
            future_development: document.getElementById('project-development').value,
            resources: document.getElementById('project-resources').value
        }
        
        // Валидация обязательных полей
        if (!projectData.project_type || !projectData.title || !projectData.description || 
            !projectData.geography || !projectData.start_date || !projectData.end_date || 
            !projectData.goal || !projectData.expected_results || !projectData.tasks) {
            alert('Пожалуйста, заполните все обязательные поля')
            return
        }
        
        try {
            // Сохраняем проект в базу данных
            const { data, error } = await supabase
                .from('projects')
                .insert([projectData])
                .select()
            
            if (error) throw error
            
            alert('Проект успешно создан!')
            showSection('projects-list-content')
            
        } catch (error) {
            console.error('Ошибка при создании проекта:', error)
            alert('Произошла ошибка при создании проекта: ' + error.message)
        }
    })
    
    // Обработчик кнопки "Назад к проектам"
    document.getElementById('back-to-projects-btn').addEventListener('click', () => {
        showSection('projects-list-content')
    })
    
    // Обработчики вкладок проекта
    document.querySelectorAll('.project-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            // Убираем активный класс у всех вкладок
            document.querySelectorAll('.project-tab').forEach(t => {
                t.classList.remove('active')
            })
            
            // Добавляем активный класс текущей вкладке
            tab.classList.add('active')
            
            // Скрываем все содержимое вкладок
            document.querySelectorAll('.project-tab-content').forEach(content => {
                content.classList.remove('active')
            })
            
            // Показываем содержимое текущей вкладки
            const tabId = tab.getAttribute('data-tab')
            document.getElementById(`${tabId}-tab`).classList.add('active')
        })
    })
    
    // Обработчики кнопок "Добавить строку"
    document.querySelectorAll('.add-row-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const type = btn.getAttribute('data-type');
            const category = budgetCategories.find(c => 
                getCategorySlug(c.name) === type
            );
            
            if (category) {
                const container = document.getElementById(`${type}-rows`);
                container.appendChild(createBudgetRow(category.id));
                setupBudgetInputListeners();
            }
        });
    });
    
 document.getElementById('save-budget-btn').addEventListener('click', async () => {
    if (!currentProject) return;
    
    try {
        // Собираем все строки бюджета
        const itemsToSave = [];
        
        document.querySelectorAll('.budget-row').forEach(row => {
            const categoryId = row.dataset.categoryId;
            const itemId = row.dataset.itemId || null;
            const category = budgetCategories.find(c => c.id == categoryId);
            const slug = getCategorySlug(category?.name || '');
            
            const amountInput = row.querySelector(`.${slug}-amount`);
            const commentInput = row.querySelector(`.${slug}-comment`);
            
            const amount = parseFloat(amountInput?.value || 0);
            const comment = commentInput?.value || '';
            
            // Сохраняем строку, если есть сумма или комментарий
            if (amount > 0 || comment.trim() !== '') {
                itemsToSave.push({
                    id: itemId ? parseInt(itemId) : null,
                    project_id: currentProject.id,
                    category_id: parseInt(categoryId),
                    amount: amount,
                    comment: comment
                });
            }
        });
        
        // Разделяем на новые и существующие элементы
        const newItems = itemsToSave.filter(item => !item.id);
        const existingItems = itemsToSave.filter(item => item.id);
        
        // Получаем ID элементов, которые нужно удалить
        const currentItemIds = existingItems.map(item => item.id);
        const itemsToDelete = budgetItems
            .filter(item => !currentItemIds.includes(item.id))
            .map(item => item.id);
        
        // Вызываем функцию Supabase для сохранения бюджета
        const { error } = await supabase.rpc('save_project_budget', {
            project_id: currentProject.id,
            items_to_insert: newItems.length > 0 ? newItems : null,
            items_to_update: existingItems.length > 0 ? existingItems : null,
            items_to_delete: itemsToDelete.length > 0 ? itemsToDelete : null
        });
        
        if (error) throw error;
        
        alert('Бюджет успешно сохранен!');
        await loadProjectBudget(currentProject.id);
        
    } catch (error) {
        console.error('Ошибка сохранения бюджета:', error);
        alert('Ошибка при сохранении бюджета: ' + (error.message || "Проверьте заполнение всех обязательных полей"));
    }
});
                    
    // Обработчик выхода из системы
    document.getElementById('logout').addEventListener('click', async () => {
        try {
            await supabase.auth.signOut()
            localStorage.removeItem('auth')
            sessionStorage.removeItem('auth')
            window.location.href = 'index.html'
        } catch (error) {
            console.error('Ошибка выхода:', error)
        }
    })
    
    // По умолчанию показываем список проектов
    showSection('projects-list-content')
})
    </script>
</body>
</html>