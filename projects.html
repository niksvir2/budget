<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление проектами</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            background-color: #f5f5f5;
        }
        
        /* Боковая панель */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 20px;
        }
        
        .sidebar-header h2 {
            margin: 0;
            color: white;
            font-size: 20px;
        }
        
        .nav-links {
            flex-grow: 1;
        }
        
        .nav-link {
            display: block;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: #34495e;
        }
        
        .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        
        .logout-btn {
            padding: 12px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 20px;
            border-radius: 4px;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* Основной контент */
        .main-content {
            margin-left: 250px;
            flex-grow: 1;
            padding: 30px;
            background-color: white;
            min-height: 100vh;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .content-header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        
        .new-project-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .new-project-btn:hover {
            background-color: #2980b9;
        }
        
        .projects-section {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .no-projects {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }
        
        .create-first-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        .create-first-btn:hover {
            background-color: #2980b9;
        }
        
        /* Стили для списка проектов */
        .projects-list {
            display: grid;
            gap: 20px;
        }

        .project-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            transition: box-shadow 0.3s;
            cursor: pointer;
        }

        .project-card:hover {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .project-title {
            margin: 0;
            font-size: 18px;
            color: #3498db;
        }

        .project-type {
            padding: 4px 8px;
            background-color: #f1f1f1;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
        }

        .project-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            margin: 0;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* Стили для просмотра проекта */
        .project-view {
            display: none;
        }

        .project-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .project-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }

        .project-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .project-tab-content {
            display: none;
        }

        .project-tab-content.active {
            display: block;
        }

        .project-info-section {
            margin-bottom: 25px;
        }

        .project-info-section h3 {
            margin: 0 0 15px 0;
            color: #3498db;
            font-size: 18px;
        }

        .project-info-section p {
            margin: 0 0 10px 0;
            line-height: 1.5;
            white-space: pre-line;
        }

        /* Стили для бюджета */
        .budget-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .budget-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-item-title {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
        }

        .budget-item-rows {
            margin-top: 10px;
        }

        .budget-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }

        .budget-row input[type="number"] {
            width: 120px;
        }

        .budget-row input[type="text"] {
            flex-grow: 1;
        }

        .add-row-btn {
            padding: 5px 10px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .total-amount {
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .back-btn {
            padding: 10px 20px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
		/* Стили для формы создания проекта */
.create-project-container {
    display: none;
}

.create-project-header {
    margin-bottom: 30px;
}

.create-project-header h1 {
    margin: 0 0 10px 0;
    font-size: 24px;
    color: #333;
}

.create-project-header p {
    margin: 0;
    color: #666;
}

.form-section {
    margin-bottom: 30px;
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.form-section-header {
    margin-bottom: 20px;
}

.form-section-header h2 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: #333;
}

.form-section-header p {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

.form-group select,
.form-group input[type="text"],
.form-group input[type="date"],
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.cancel-btn {
    padding: 10px 20px;
    background-color: #f1f1f1;
    color: #333;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.cancel-btn:hover {
    background-color: #e0e0e0;
}

.submit-btn {
    padding: 10px 20px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.submit-btn:hover {
    background-color: #2980b9;
}
    </style>
</head>
<body>
    <!-- Боковая панель -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Управление проектами</h2>
        </div>
        
        <div class="nav-links">
            <a href="#" class="nav-link" id="dashboard-link">Панель управления</a>
            <a href="#" class="nav-link active" id="projects-link">Мои проекты</a>
            <a href="#" class="nav-link" id="profile-link">Мой профиль</a>
            <a href="#" class="nav-link" id="settings-link">Настройки</a>
        </div>
        
        <button class="logout-btn" id="logout">Выйти</button>
    </div>
    
    <!-- Основной контент - Панель управления -->
    <div class="main-content" id="dashboard-content">
        <div class="content-header">
            <h1>Панель управления</h1>
            <button class="new-project-btn" id="new-project-btn">Создать новый проект</button>
        </div>
        
        <div class="projects-section">
            <div class="section-header">
                <h2>Последние проекты</h2>
            </div>
            
            <div class="no-projects">
                <p>У вас пока нет созданных проектов</p>
                <button class="create-first-btn" id="create-first-btn">Создать первый проект</button>
            </div>
        </div>
    </div>
    
    <!-- Форма создания проекта -->
    <div class="main-content create-project-container" id="create-project-content">
        <div class="create-project-header">
            <h1>Создание нового проекта</h1>
            <p>Заполните форму для создания нового проекта</p>
        </div>
        
        <!-- Основная информация -->
        <div class="form-section">
            <div class="form-section-header">
                <h2>Основная информация</h2>
                <p>Укажите основные параметры проекта</p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="project-type">Тип проекта</label>
                    <select id="project-type">
                        <option value="">Выберите тип проекта</option>
                        <option value="research">Исследовательский</option>
                        <option value="development">Разработка</option>
                        <option value="education">Образовательный</option>
                        <option value="social">Социальный</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="project-name">Название проекта</label>
                    <input type="text" id="project-name" placeholder="Введите название проекта">
                </div>
            </div>
            
            <div class="form-group">
                <label for="project-description">Описание проекта</label>
                <textarea id="project-description" placeholder="Опишите ваш проект"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-geography">География проекта</label>
                <input type="text" id="project-geography" placeholder="Укажите географию проекта">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="start-date">Дата начала реализации</label>
                    <input type="date" id="start-date">
                </div>
                
                <div class="form-group">
                    <label for="end-date">Дата окончания реализации</label>
                    <input type="date" id="end-date">
                </div>
            </div>
        </div>
        
        <!-- Содержание проекта -->
        <div class="form-section">
            <div class="form-section-header">
                <h2>Содержание проекта</h2>
                <p>Детальная информация о целях и результатах проекта</p>
            </div>
            
            <div class="form-group">
                <label for="project-goal">Цель проекта</label>
                <textarea id="project-goal" placeholder="Сформулируйте основную цель проекта"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-results">Ожидаемые результаты проекта</label>
                <textarea id="project-results" placeholder="Опишите ожидаемые результаты"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-tasks">Задачи проекта</label>
                <textarea id="project-tasks" placeholder="Перечислите основные задачи проекта"></textarea>
            </div>
        </div>
        
        <!-- Дополнительная информация -->
        <div class="form-section">
            <div class="form-section-header">
                <h2>Дополнительная информация</h2>
                <p>Необязательные, но полезные данные о проекте</p>
            </div>
            
            <div class="form-group">
                <label for="project-partners">Партнеры проекта</label>
                <textarea id="project-partners" placeholder="Укажите партнеров проекта (если есть)"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-development">Дальнейшее развитие проекта</label>
                <textarea id="project-development" placeholder="Опишите перспективы развития проекта"></textarea>
            </div>
            
            <div class="form-group">
                <label for="project-resources">Источники ресурсного обеспечения проекта</label>
                <textarea id="project-resources" placeholder="Укажите источники финансирования и другие ресурсы"></textarea>
            </div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="form-actions">
            <button class="cancel-btn" id="cancel-project-btn">Отмена</button>
            <button class="submit-btn" id="submit-project-btn">Создать проект</button>
        </div>
    </div>
    
    <!-- Список проектов -->
    <div class="main-content" id="projects-list-content">
        <div class="content-header">
            <h1>Мои проекты</h1>
            <button class="new-project-btn" id="new-project-btn-list">Создать новый проект</button>
        </div>
        
        <div class="projects-section">
            <div id="projects-container">
                <div class="no-projects">
                    <p>Загрузка проектов...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Просмотр проекта -->
    <div class="main-content project-view" id="project-view-content">
        <div class="content-header">
            <h1 id="project-view-title">Название проекта</h1>
            <button class="back-btn" id="back-to-projects-btn">← Назад к проектам</button>
        </div>
        
        <div class="projects-section">
            <div class="project-tabs">
                <button class="project-tab active" data-tab="overview">Обзор</button>
                <button class="project-tab" data-tab="budget">Бюджет</button>
            </div>
            
            <div class="project-tab-content active" id="overview-tab">
                <div class="project-info-section">
                    <h3>Основная информация</h3>
                    <p><strong>Тип проекта:</strong> <span id="project-type-view"></span></p>
                    <p><strong>Описание:</strong> <span id="project-description-view"></span></p>
                    <p><strong>География:</strong> <span id="project-geography-view"></span></p>
                    <p><strong>Дата начала:</strong> <span id="project-start-date-view"></span></p>
                    <p><strong>Дата окончания:</strong> <span id="project-end-date-view"></span></p>
                </div>
                
                <div class="project-info-section">
                    <h3>Содержание проекта</h3>
                    <p><strong>Цель проекта:</strong> <span id="project-goal-view"></span></p>
                    <p><strong>Ожидаемые результаты:</strong> <span id="project-results-view"></span></p>
                    <p><strong>Задачи проекта:</strong> <span id="project-tasks-view"></span></p>
                </div>
                
                <div class="project-info-section">
                    <h3>Дополнительная информация</h3>
                    <p><strong>Партнеры:</strong> <span id="project-partners-view"></span></p>
                    <p><strong>Дальнейшее развитие:</strong> <span id="project-development-view"></span></p>
                    <p><strong>Ресурсы:</strong> <span id="project-resources-view"></span></p>
                </div>
            </div>
            
             <div class="project-tab-content" id="budget-tab">
            <h2>Бюджет проекта</h2>
            
            <!-- 1. Оплата труда -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">1.1 Оплата труда штатных работников</h3>
                    </div>
                    <div class="budget-item-rows" id="salary-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="salary-amount">
                            <input type="text" placeholder="Комментарий" class="salary-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="salary">Добавить строку</button>
                </div>
                
                <!-- 1.2. Выплаты физическим лицам -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">1.2. Выплаты физическим лицам по гражданско-правовым договорам</h3>
                    </div>
                    <div class="budget-item-rows" id="contract-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="contract-amount">
                            <input type="text" placeholder="Комментарий" class="contract-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="contract">Добавить строку</button>
                </div>
                
                <!-- 1.3. Страховые взносы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">1.3. Страховые взносы</h3>
                    </div>
                    <div class="budget-item-rows" id="insurance-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="insurance-amount">
                            <input type="text" placeholder="Комментарий" class="insurance-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="insurance">Добавить строку</button>
                </div>
                
                <!-- 2. Командировочные расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">2. Командировочные расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="travel-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="travel-amount">
                            <input type="text" placeholder="Комментарий" class="travel-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="travel">Добавить строку</button>
                </div>
                
                <!-- 3. Офисные расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">3. Офисные расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="office-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="office-amount">
                            <input type="text" placeholder="Комментарий" class="office-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="office">Добавить строку</button>
                </div>
                
                <!-- 4. Приобретение оборудования -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">4. Приобретение, аренда специализированного оборудования</h3>
                    </div>
                    <div class="budget-item-rows" id="equipment-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="equipment-amount">
                            <input type="text" placeholder="Комментарий" class="equipment-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="equipment">Добавить строку</button>
                </div>
                
                <!-- 5. Разработка и поддержка сайтов -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">5. Разработка и поддержка сайтов, информационных систем</h3>
                    </div>
                    <div class="budget-item-rows" id="it-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="it-amount">
                            <input type="text" placeholder="Комментарий" class="it-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="it">Добавить строку</button>
                </div>
                
                <!-- 6. Консультационные услуги -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">6. Оплата юридических, информационных, консультационных услуг</h3>
                    </div>
                    <div class="budget-item-rows" id="consulting-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="consulting-amount">
                            <input type="text" placeholder="Комментарий" class="consulting-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="consulting">Добавить строку</button>
                </div>
                
                <!-- 7. Расходы на мероприятия -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">7. Расходы на проведение мероприятий</h3>
                    </div>
                    <div class="budget-item-rows" id="event-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="event-amount">
                            <input type="text" placeholder="Комментарий" class="event-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="event">Добавить строку</button>
                </div>
                
                <!-- 8. Издательские расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">8. Издательские, полиграфические расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="publishing-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="publishing-amount">
                            <input type="text" placeholder="Комментарий" class="publishing-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="publishing">Добавить строку</button>
                </div>
                
                <!-- 9. Прочие расходы -->
                <div class="budget-item">
                    <div class="budget-item-header">
                        <h3 class="budget-item-title">9. Прочие прямые расходы</h3>
                    </div>
                    <div class="budget-item-rows" id="other-rows">
                        <div class="budget-row">
                            <input type="number" placeholder="Сумма" class="other-amount">
                            <input type="text" placeholder="Комментарий" class="other-comment">
                        </div>
                    </div>
                    <button class="add-row-btn" data-type="other">Добавить строку</button>
                </div>
                
                <div class="total-amount">
                    Общая сумма затрат: <span id="total-amount">0</span> руб.
                </div>
                
                <button class="submit-btn" id="save-budget-btn">Сохранить бюджет</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        
        // Инициализация Supabase
        const supabaseUrl = 'https://ijksnxqnabykqjvqeoud.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqa3NueHFuYWJ5a3FqdnFlb3VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNDI0MzMsImV4cCI6MjA2NDYxODQzM30.TXQO0z4iEP95eVVwirdEwww0BWJyPmKKg_DSC4SSr9Q'
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        // Текущий просматриваемый проект
        let currentProject = null;
        let currentBudgetItems = [];
        
        // Проверка авторизации
        async function checkAuth() {
            const session = JSON.parse(localStorage.getItem('auth')) || JSON.parse(sessionStorage.getItem('auth'))
            
            if (!session) {
                window.location.href = 'index.html'
                return null
            }
            
            try {
                const { data, error } = await supabase.auth.getUser(session.access_token)
                
                if (error) {
                    localStorage.removeItem('auth')
                    sessionStorage.removeItem('auth')
                    window.location.href = 'index.html'
                    return null
                }
                return data.user
            } catch (error) {
                console.error('Ошибка проверки авторизации:', error)
                window.location.href = 'index.html'
                return null
            }
        }
        
        // Форматирование даты
        function formatDate(dateString) {
            if (!dateString) return 'Не указана'
            const date = new Date(dateString)
            return date.toLocaleDateString('ru-RU')
        }
        
        // Загрузка проектов пользователя
        async function loadUserProjects(userId) {
            const projectsContainer = document.getElementById('projects-container')
            projectsContainer.innerHTML = '<div class="no-projects"><p>Загрузка проектов...</p></div>'
            
            try {
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                
                if (error) throw error
                
                if (projects.length === 0) {
                    projectsContainer.innerHTML = `
                        <div class="no-projects">
                            <p>У вас пока нет проектов</p>
                            <button class="create-first-btn" id="create-first-btn-list">Создать первый проект</button>
                        </div>
                    `
                } else {
                    projectsContainer.innerHTML = `
                        <div class="projects-list">
                            ${projects.map(project => `
                                <div class="project-card" data-project-id="${project.id}">
                                    <div class="project-header">
                                        <h3 class="project-title">${project.title || 'Без названия'}</h3>
                                        <span class="project-type">${project.project_type || 'Не указан'}</span>
                                    </div>
                                    <div class="project-details">
                                        <div class="detail-item">
                                            <div class="detail-label">Начало</div>
                                            <div class="detail-value">${formatDate(project.start_date)}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Окончание</div>
                                            <div class="detail-value">${formatDate(project.end_date)}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">География</div>
                                            <div class="detail-value">${project.geography || 'Не указана'}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `

                    // Добавляем обработчики клика на карточки проектов
                    document.querySelectorAll('.project-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            const projectId = card.getAttribute('data-project-id')
                            const project = projects.find(p => p.id == projectId)
                            if (project) {
                                showProjectDetails(project)
                            }
                        })
                    })
                }
            } catch (error) {
                console.error('Ошибка загрузки проектов:', error)
                projectsContainer.innerHTML = `
                    <div class="no-projects">
                        <p>Ошибка загрузки проектов</p>
                    </div>
                `
            }
        }
        
        // Загрузка данных бюджета для проекта
        async function loadProjectBudget(projectId) {
            try {
                const { data, error } = await supabase
                    .from('budget_items')
                    .select('*')
                    .eq('project_id', projectId)
                
                if (error) throw error
                
                currentBudgetItems = data || [];
                renderBudgetItems();
                calculateTotal();
            } catch (error) {
                console.error('Ошибка загрузки бюджета:', error)
                alert('Ошибка загрузки данных бюджета')
            }
        }
        // Заполнение строк бюджета
function fillBudgetRows(type, amounts, comments) {
    const container = document.getElementById(`${type}-rows`);
    
    // Очищаем все строки, кроме первой
    while (container.children.length > 1) {
        container.removeChild(container.lastChild);
    }
    
    // Если amounts - это массив, заполняем строки
    if (Array.isArray(amounts)) {
        amounts.forEach((amount, index) => {
            // Для первой строки используем существующие поля
            if (index === 0) {
                container.querySelector(`.${type}-amount`).value = amount || '';
                container.querySelector(`.${type}-comment`).value = (comments && comments[index]) || '';
            } else {
                // Добавляем новые строки для остальных элементов
                const newRow = document.createElement('div');
                newRow.className = 'budget-row';
                newRow.innerHTML = `
                    <input type="number" placeholder="Сумма" class="${type}-amount" value="${amount || ''}">
                    <input type="text" placeholder="Комментарий" class="${type}-comment" value="${(comments && comments[index]) || ''}">
                `;
                container.appendChild(newRow);
            }
        });
    } else if (amounts !== undefined && amounts !== null) {
        // Если amounts - это одно значение (не массив)
        container.querySelector(`.${type}-amount`).value = amounts || '';
        container.querySelector(`.${type}-comment`).value = comments || '';
    }
}
        // Отображение данных бюджета
function renderBudgetItems() {
    if (!currentBudgetItems.length) {
        // Если нет данных бюджета, очищаем все поля
        document.querySelectorAll('[class$="-amount"]').forEach(input => input.value = '');
        document.querySelectorAll('[class$="-comment"]').forEach(input => input.value = '');
        calculateTotal();
        return;
    }
    
    const budgetItem = currentBudgetItems[0];
    
    // Заполняем данные для каждой категории
    fillBudgetRows('salary', budgetItem.salary_expenses, budgetItem.comments);
    fillBudgetRows('contract', budgetItem.contract_payments, budgetItem.comments);
    fillBudgetRows('insurance', budgetItem.insurance_contributions, budgetItem.comments);
    fillBudgetRows('travel', budgetItem.travel_expenses, budgetItem.comments);
    fillBudgetRows('office', budgetItem.office_expenses, budgetItem.comments);
    fillBudgetRows('equipment', budgetItem.equipment_costs, budgetItem.comments);
    fillBudgetRows('it', budgetItem.it_costs, budgetItem.comments);
    fillBudgetRows('consulting', budgetItem.consulting_fees, budgetItem.comments);
    fillBudgetRows('event', budgetItem.event_costs, budgetItem.comments);
    fillBudgetRows('publishing', budgetItem.publishing_costs, budgetItem.comments);
    fillBudgetRows('other', budgetItem.other_expenses, budgetItem.comments);
    
    // Пересчитываем общую сумму
    calculateTotal();
}

        // Расчет общей суммы
        function calculateTotal() {
            let total = 0;
            
            // Суммируем значения всех полей ввода с суммами
            document.querySelectorAll('[class$="-amount"]').forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    total += value;
                }
            });
            
            document.getElementById('total-amount').textContent = total.toFixed(2);
        }

        // Установка обработчиков событий для полей ввода
        function setupBudgetInputListeners() {
            document.querySelectorAll('[class$="-amount"]').forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
        }
        
        // Показ деталей проекта
        async function showProjectDetails(project) {
            currentProject = project;
            
            // Заполняем информацию о проекте
            document.getElementById('project-view-title').textContent = project.title || 'Без названия';
            document.getElementById('project-type-view').textContent = project.project_type || 'Не указан';
            document.getElementById('project-description-view').textContent = project.description || 'Не указано';
            document.getElementById('project-geography-view').textContent = project.geography || 'Не указана';
            document.getElementById('project-start-date-view').textContent = formatDate(project.start_date);
            document.getElementById('project-end-date-view').textContent = formatDate(project.end_date);
            document.getElementById('project-goal-view').textContent = project.goal || 'Не указана';
            document.getElementById('project-results-view').textContent = project.expected_results || 'Не указаны';
            document.getElementById('project-tasks-view').textContent = project.tasks || 'Не указаны';
            document.getElementById('project-partners-view').textContent = project.partners || 'Не указаны';
            document.getElementById('project-development-view').textContent = project.future_development || 'Не указано';
            document.getElementById('project-resources-view').textContent = project.resources || 'Не указаны';
            
            // Загружаем данные бюджета
            await loadProjectBudget(project.id);
            
            // Настраиваем обработчики событий для полей ввода
            setupBudgetInputListeners();
            
            // Показываем вкладку просмотра проекта
            showSection('project-view-content');
        }
        
        // Переключение между разделами
        function showSection(sectionId) {
            const sections = ['dashboard-content', 'create-project-content', 'projects-list-content', 'project-view-content']
            sections.forEach(id => {
                document.getElementById(id).style.display = id === sectionId ? 'block' : 'none'
            })
            
            // Обновляем активную ссылку в навигации
            const navLinks = ['dashboard-link', 'projects-link', 'profile-link', 'settings-link']
            navLinks.forEach(id => {
                const link = document.getElementById(id)
                if (link) {
                    link.classList.toggle('active', id === `${sectionId.replace('-content', '-link')}`)
                }
            })
            
            // Если показываем список проектов - загружаем их
            if (sectionId === 'projects-list-content') {
                checkAuth().then(user => {
                    if (user) loadUserProjects(user.id)
                })
            }
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth()
            if (!user) return
            
            // Настройка обработчиков навигации
            document.getElementById('dashboard-link').addEventListener('click', (e) => {
                e.preventDefault()
                showSection('dashboard-content')
            })
            
            document.getElementById('projects-link').addEventListener('click', (e) => {
                e.preventDefault()
                showSection('projects-list-content')
            })
            
            // Обработчики кнопок создания проекта
            document.getElementById('new-project-btn').addEventListener('click', () => {
                showSection('create-project-content')
            })
            
            document.getElementById('new-project-btn-list').addEventListener('click', () => {
                showSection('create-project-content')
            })
            
            document.getElementById('create-first-btn').addEventListener('click', () => {
                showSection('create-project-content')
            })
            
            // Обработчик для кнопки в списке проектов (если нет проектов)
            document.addEventListener('click', (e) => {
                if (e.target.id === 'create-first-btn-list') {
                    showSection('create-project-content')
                }
            })
            
            // Обработчик кнопки отмены
            document.getElementById('cancel-project-btn').addEventListener('click', () => {
                showSection('projects-list-content')
            })
            
            // Обработчик кнопки создания проекта
            document.getElementById('submit-project-btn').addEventListener('click', async () => {
                const user = await checkAuth()
                if (!user) return
                
                // Собираем данные из формы
                const projectData = {
                    user_id: user.id,
                    project_type: document.getElementById('project-type').value,
                    title: document.getElementById('project-name').value,
                    description: document.getElementById('project-description').value,
                    geography: document.getElementById('project-geography').value,
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value,
                    goal: document.getElementById('project-goal').value,
                    expected_results: document.getElementById('project-results').value,
                    tasks: document.getElementById('project-tasks').value,
                    partners: document.getElementById('project-partners').value,
                    future_development: document.getElementById('project-development').value,
                    resources: document.getElementById('project-resources').value
                }
                
                // Валидация обязательных полей
                if (!projectData.project_type || !projectData.title || !projectData.description || 
                    !projectData.geography || !projectData.start_date || !projectData.end_date || 
                    !projectData.goal || !projectData.expected_results || !projectData.tasks) {
                    alert('Пожалуйста, заполните все обязательные поля')
                    return
                }
                
                try {
                    // Сохраняем проект в базу данных
                    const { data, error } = await supabase
                        .from('projects')
                        .insert([projectData])
                        .select()
                    
                    if (error) throw error
                    
                    alert('Проект успешно создан!')
                    showSection('projects-list-content')
                    
                } catch (error) {
                    console.error('Ошибка при создании проекта:', error)
                    alert('Произошла ошибка при создании проекта: ' + error.message)
                }
            })
            
            // Обработчик кнопки "Назад к проектам"
            document.getElementById('back-to-projects-btn').addEventListener('click', () => {
                showSection('projects-list-content')
            })
            
            // Обработчики вкладок проекта
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Убираем активный класс у всех вкладок
                    document.querySelectorAll('.project-tab').forEach(t => {
                        t.classList.remove('active')
                    })
                    
                    // Добавляем активный класс текущей вкладке
                    tab.classList.add('active')
                    
                    // Скрываем все содержимое вкладок
                    document.querySelectorAll('.project-tab-content').forEach(content => {
                        content.classList.remove('active')
                    })
                    
                    // Показываем содержимое текущей вкладки
                    const tabId = tab.getAttribute('data-tab')
                    document.getElementById(`${tabId}-tab`).classList.add('active')
                })
            })
            
            // Обработчики кнопок "Добавить строку"
            document.querySelectorAll('.add-row-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.getAttribute('data-type');
                    const container = document.getElementById(`${type}-rows`);
                    
                    const newRow = document.createElement('div');
                    newRow.className = 'budget-row';
                    newRow.innerHTML = `
                        <input type="number" placeholder="Сумма" class="${type}-amount">
                        <input type="text" placeholder="Комментарий" class="${type}-comment">
                    `;
                    
                    container.appendChild(newRow);
                    
                    // Добавляем обработчик для нового поля ввода
                    newRow.querySelector(`.${type}-amount`).addEventListener('input', calculateTotal);
                });
            });
            
            // Обработчик сохранения бюджета
document.getElementById('save-budget-btn').addEventListener('click', async () => {
    if (!currentProject) return;
    
    try {
        // Собираем данные из формы
        const budgetData = {
            project_id: currentProject.id,
            amount: calculateTotalAmount(), // Обязательное поле
            comments: collectComments(),
            description: "Бюджет проекта", // Можно изменить на что-то более осмысленное
            salary_expenses: sumInputValues('.salary-amount'),
            contract_payments: sumInputValues('.contract-amount'),
            insurance_contributions: sumInputValues('.insurance-amount'),
            travel_expenses: sumInputValues('.travel-amount'),
            office_expenses: sumInputValues('.office-amount'),
            equipment_costs: sumInputValues('.equipment-amount'),
            it_costs: sumInputValues('.it-amount'),
            consulting_fees: sumInputValues('.consulting-amount'),
            event_costs: sumInputValues('.event-amount'),
            publishing_costs: sumInputValues('.publishing-amount'),
            other_expenses: sumInputValues('.other-amount'),
            // created_at автоматически заполняется триггером
        };

        // Удаляем старые записи бюджета (если нужно)
        const { error: deleteError } = await supabase
            .from('budget_items')
            .delete()
            .eq('project_id', currentProject.id);
        
        if (deleteError) throw deleteError;
        
        // Сохраняем в базу данных
        const { data, error } = await supabase
            .from('budget_items')
            .insert([budgetData])
            .select();
        
        if (error) throw error;
        
        alert('Бюджет успешно сохранен!');
        await loadProjectBudget(currentProject.id);
        
    } catch (error) {
        console.error('Ошибка сохранения бюджета:', error);
        alert('Ошибка при сохранении бюджета: ' + (error.message || "Проверьте заполнение всех обязательных полей"));
    }
});

// Функция для расчета общей суммы (возвращает число)
function calculateTotalAmount() {
    let total = 0;
    document.querySelectorAll('[class$="-amount"]').forEach(input => {
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            total += value;
        }
    });
    return total;
}

// Функция для суммирования значений полей ввода (возвращает 0 для пустых значений)
function sumInputValues(selector) {
    let sum = 0;
    document.querySelectorAll(selector).forEach(input => {
        sum += parseFloat(input.value) || 0;
    });
    return sum;
}

// Функция для сбора комментариев (можно улучшить)
function collectComments() {
    let comments = [];
    document.querySelectorAll('[class$="-comment"]').forEach(input => {
        if (input.value) {
            comments.push(input.value);
        }
    });
    return comments.join("\n") || "";
}
            
            // Обработчик выхода из системы
            document.getElementById('logout').addEventListener('click', async () => {
                try {
                    await supabase.auth.signOut()
                    localStorage.removeItem('auth')
                    sessionStorage.removeItem('auth')
                    window.location.href = 'index.html'
                } catch (error) {
                    console.error('Ошибка выхода:', error)
                }
            })
            
            // По умолчанию показываем список проектов
            showSection('projects-list-content')
        })
    </script>
</body>
</html>